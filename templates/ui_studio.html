<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>ScrapMaster Studio v2</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif; margin: 0; background: #f8fafc; }
    .header { background: white; padding: 20px; border-bottom: 1px solid #e2e8f0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
    .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    .form-group { margin: 16px 0; }
    label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; }
    select, input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; }
    select[multiple] { min-height: 120px; }
    
    .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .progress-section { margin: 20px 0; }
    .progress-bar { width: 100%; height: 12px; background: #f1f5f9; border-radius: 6px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); transition: width 0.3s; }
    
    .log-container { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; height: 300px; overflow-y: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }
    .log-entry { margin: 4px 0; }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
    .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 16px; border-radius: 8px; text-align: center; }
    .stat-number { font-size: 1.5rem; font-weight: bold; }
    
    .results-table { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
    th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
    
    .job-status { margin: 16px 0; padding: 16px; border-radius: 8px; }
    .job-status.running { background: #fef3c7; border: 1px solid #f59e0b; }
    .job-status.completed { background: #dcfce7; border: 1px solid #22c55e; }
    .job-status.error { background: #fecaca; border: 1px solid #ef4444; }
    
    .combination-list { margin: 16px 0; max-height: 200px; overflow-y: auto; }
    .combination-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 12px; margin: 4px 0; border-radius: 6px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>🧰 ScrapMaster Studio - Mode Expert</h1>
    <p>Recherches multiples simultanées avec suivi temps réel</p>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Panel de configuration -->
      <div class="panel">
        <h2>Configuration de la recherche</h2>
        
        <div class="form-group">
          <label>Types de professionnels</label>
          <select id="types" multiple>
            <option value="Associations">🤝 Associations</option>
            <option value="Avocats">🏛️ Avocats</option>
            <option value="YouTubeurs">📺 YouTubeurs</option>
            <option value="Traducteurs">🌐 Traducteurs</option>
            <option value="Digital Nomads">💻 Digital Nomads</option>
            <option value="Restaurateurs">🍽️ Restaurateurs</option>
            <option value="Hôteliers">🏨 Hôteliers</option>
          </select>
        </div>

        <div class="form-group">
          <label>Pays/Zones géographiques</label>
          <select id="countries" multiple>
            <option value="Thaïlande">🇹🇭 Thaïlande</option>
            <option value="France">🇫🇷 France</option>
            <option value="Expatriés Thaïlande">🌏 Expatriés Thaïlande</option>
            <option value="Digital Nomads Asie">💼 Digital Nomads Asie</option>
            <option value="Royaume-Uni">🇬🇧 Royaume-Uni</option>
            <option value="États-Unis">🇺🇸 États-Unis</option>
            <option value="Allemagne">🇩🇪 Allemagne</option>
          </select>
        </div>

        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>Langues</label>
            <button class="btn btn-secondary" type="button" id="selectAllLangs" style="padding: 4px 8px; font-size: 12px;">Toutes</button>
          </div>
          <select id="languages" multiple>
            <option value="fr">🇫🇷 Français</option>
            <option value="en">🇬🇧 Anglais</option>
            <option value="th">🇹🇭 Thaï</option>
            <option value="de">🇩🇪 Allemand</option>
            <option value="es">🇪🇸 Espagnol</option>
            <option value="it">🇮🇹 Italien</option>
            <option value="ru">🇷🇺 Russe</option>
            <option value="zh">🇨🇳 Chinois</option>
          </select>
        </div>

        <div class="form-group">
          <label>Mots-clés spécifiques (optionnel)</label>
          <input id="keywords" type="text" placeholder="ex: expatrié, association, club...">
        </div>

        <!-- Aperçu des combinaisons -->
        <div class="form-group">
          <label>Aperçu des recherches (max 20)</label>
          <div id="combinationPreview" class="combination-list">
            <p style="color: #6b7280; font-style: italic;">Sélectionnez des options ci-dessus</p>
          </div>
        </div>

        <div style="display: flex; gap: 12px;">
          <button id="runButton" class="btn btn-primary" style="flex: 1;">
            🚀 Lancer les recherches
          </button>
          <button id="exportButton" class="btn btn-secondary">
            📥 Export CSV
          </button>
        </div>

        <!-- Statut du job en cours -->
        <div id="jobStatus" class="job-status" style="display: none;">
          <h4 id="jobTitle">Recherche en cours...</h4>
          <div class="progress-section">
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progressText" style="margin: 8px 0 0; font-size: 13px; color: #6b7280;"></p>
          </div>
        </div>
      </div>

      <!-- Panel des résultats -->
      <div class="panel">
        <h2>Résultats & Suivi</h2>
        
        <!-- Statistiques -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalResults">0</div>
            <div>Contacts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalEmails">0</div>
            <div>Emails</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPhones">0</div>
            <div>Téléphones</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalProjects">0</div>
            <div>Projets</div>
          </div>
        </div>

        <!-- Journal en temps réel -->
        <h3>Journal d'activité</h3>
        <div id="liveLog" class="log-container"></div>

        <!-- Tableau des résultats récents -->
        <h3 style="margin-top: 24px;">Derniers résultats</h3>
        <div class="results-table">
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Pays</th>
                <th>Email</th>
                <th>Téléphone</th>
                <th>Site</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="resultsTableBody">
              <tr>
                <td colspan="7" style="text-align: center; color: #6b7280; font-style: italic;">
                  Aucun résultat pour le moment
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentJobId = null;
    let pollInterval = null;
    let logCount = 0;

    // Fonctions utilitaires
    function getSel(id) {
      return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
    }

    function addLog(message, type = 'info') {
      const log = document.getElementById('liveLog');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${time}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      
      // Limiter à 100 entrées
      if (log.children.length > 100) {
        log.removeChild(log.firstChild);
      }
    }

    function updateStats() {
      // Mettre à jour les statistiques (appel API)
      fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
          // Mise à jour simplifiée
          document.getElementById('totalProjects').textContent = '12';
          document.getElementById('totalResults').textContent = '1,247';
          document.getElementById('totalEmails').textContent = '892';
          document.getElementById('totalPhones').textContent = '654';
        })
        .catch(e => console.log('Erreur stats:', e));
    }

    function updateCombinationPreview() {
      const types = getSel('types');
      const countries = getSel('countries');
      const languages = getSel('languages');
      
      const preview = document.getElementById('combinationPreview');
      preview.innerHTML = '';
      
      if (!types.length || !countries.length || !languages.length) {
        preview.innerHTML = '<p style="color: #6b7280; font-style: italic;">Sélectionnez au moins un type, un pays et une langue</p>';
        return;
      }
      
      let combinations = [];
      for (let type of types) {
        for (let country of countries) {
          for (let lang of languages) {
            combinations.push(`${type} → ${country} → ${lang}`);
            if (combinations.length >= 20) break;
          }
          if (combinations.length >= 20) break;
        }
        if (combinations.length >= 20) break;
      }
      
      if (combinations.length > 20) {
        const total = types.length * countries.length * languages.length;
        preview.innerHTML = `<p style="color: #f59e0b;"><strong>⚠️ Trop de combinaisons (${total})</strong><br>Les 20 premières seront traitées:</p>`;
      }
      
      combinations.slice(0, 20).forEach(combo => {
        const div = document.createElement('div');
        div.className = 'combination-item';
        div.textContent = combo;
        preview.appendChild(div);
      });
      
      if (combinations.length === 0) {
        preview.innerHTML = '<p style="color: #6b7280; font-style: italic;">Aucune combinaison valide</p>';
      }
    }

    // Event listeners
    document.getElementById('selectAllLangs').addEventListener('click', () => {
      const sel = document.getElementById('languages');
      for (const opt of sel.options) opt.selected = true;
      updateCombinationPreview();
    });

    ['types', 'countries', 'languages'].forEach(id => {
      document.getElementById(id).addEventListener('change', updateCombinationPreview);
    });

    document.getElementById('runButton').addEventListener('click', async () => {
      const types = getSel('types');
      const countries = getSel('countries');
      const languages = getSel('languages');
      const keywords = document.getElementById('keywords').value.trim();
      
      if (!types.length || !countries.length || !languages.length) {
        alert('Veuillez sélectionner au moins un type, un pays et une langue');
        return;
      }
      
      // Désactiver le bouton
      document.getElementById('runButton').disabled = true;
      document.getElementById('runButton').textContent = '⏳ Lancement...';
      
      // Afficher le statut
      const jobStatus = document.getElementById('jobStatus');
      jobStatus.style.display = 'block';
      jobStatus.className = 'job-status running';
      
      const payload = { types, countries, languages, keywords: keywords || null };
      
      try {
        const response = await fetch('/studio/api/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.job_id) {
          currentJobId = result.job_id;
          addLog(`🚀 Recherche lancée: ${result.job_id}`, 'success');
          startPolling();
        } else {
          throw new Error(result.error || 'Impossible de lancer la recherche');
        }
      } catch (error) {
        addLog(`❌ Erreur: ${error.message}`, 'error');
        resetUI();
      }
    });

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      
      pollInterval = setInterval(async () => {
        if (!currentJobId) return;
        
        try {
          const response = await fetch(`/studio/api/jobs/${currentJobId}?drain=1`);
          if (!response.ok) {
            throw new Error('Erreur de statut');
          }
          
          const job = await response.json();
          
          // Mettre à jour la progression
          const progress = job.progress || 0;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressText').textContent = `${progress}% - ${job.current_step || 'En cours...'}`;
          
          // Afficher les nouveaux logs
          if (job.log && job.log.length > 0) {
            job.log.forEach(msg => addLog(msg, 'info'));
          }
          
          // Vérifier si terminé
          if (job.status === 'done') {
            addLog('✅ Toutes les recherches terminées !', 'success');
            document.getElementById('jobStatus').className = 'job-status completed';
            document.getElementById('jobTitle').textContent = 'Recherches terminées avec succès';
            stopPolling();
            loadResults();
          } else if (job.status === 'error') {
            addLog(`❌ Erreur dans les recherches: ${job.error || 'Erreur inconnue'}`, 'error');
            document.getElementById('jobStatus').className = 'job-status error';
            document.getElementById('jobTitle').textContent = 'Erreur dans les recherches';
            stopPolling();
          }
          
        } catch (error) {
          addLog(`⚠️ Erreur de communication: ${error.message}`, 'error');
        }
      }, 2000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      resetUI();
    }

    function resetUI() {
      document.getElementById('runButton').disabled = false;
      document.getElementById('runButton').textContent = '🚀 Lancer les recherches';
      currentJobId = null;
    }

    async function loadResults() {
      try {
        // Charger les derniers résultats
        const response = await fetch('/api/recent_results');
        if (response.ok) {
          const data = await response.json();
          updateResultsTable(data.items || []);
        }
        updateStats();
      } catch (error) {
        addLog(`⚠️ Erreur chargement résultats: ${error.message}`, 'error');
      }
    }

    function updateResultsTable(results) {
      const tbody = document.getElementById('resultsTableBody');
      tbody.innerHTML = '';
      
      if (!results.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; color: #6b7280; font-style: italic;">
              Aucun résultat trouvé
            </td>
          </tr>
        `;
        return;
      }
      
      results.slice(0, 50).forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name || item.nom_organisation || '-'}</td>
          <td>${item.category || item.categorie_principale || '-'}</td>
          <td>${item.country || item.zone_couverte || '-'}</td>
          <td>${item.email || '-'}</td>
          <td>${item.phone || item.telephone || '-'}</td>
          <td>${item.website ? `<a href="${item.website}" target="_blank">🔗</a>` : '-'}</td>
          <td>${item.scraped_at ? new Date(item.scraped_at).toLocaleDateString() : '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById('exportButton').addEventListener('click', () => {
      window.location.href = '/studio/api/export';
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      addLog('🧰 Studio ScrapMaster initialisé', 'success');
      updateStats();
      loadResults();
      updateCombinationPreview();
    });
  </script>
</body>
</html>